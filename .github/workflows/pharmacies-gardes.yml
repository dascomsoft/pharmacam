name: ğŸ¥ Mise Ã  jour quotidienne des pharmacies de garde

on:
  schedule:
    - cron: '0 7 * * *'  # Tous les jours Ã  7h UTC (8h heure Cameroun)
  workflow_dispatch:     # DÃ©clenchement manuel
  push:
    branches: [ main ]
    paths:
      - 'scripts/scrape-gardes-*.js'

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
      - name: ğŸ”„ Synchroniser avec le dÃ©pÃ´t
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package.json'

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”„ Installation des dÃ©pendances (prod + dev pour le scraper)..."
          npm ci  # â† Tous les packages nÃ©cessaires
          echo "âœ… DÃ©pendances installÃ©es"
          npm list --depth=0

      - name: ğŸš€ ExÃ©cution du scraper
        id: scrape
        run: |
          echo "ğŸ¯ DÃ©marrage du scraping des pharmacies de garde..."
          echo "ğŸŒ Source: https://www.dochelp-cm.org"
          
          START_TIME=$(date +%s)
          node scripts/scrape-gardes-optimized.js
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "â±ï¸  DurÃ©e d'exÃ©cution: ${DURATION} secondes"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ Le scraper a Ã©chouÃ© avec le code: $EXIT_CODE"
            exit 1
          fi
          
          echo "âœ… Scraping terminÃ© avec succÃ¨s"

      - name: ğŸ“Š Analyse des donnÃ©es gÃ©nÃ©rÃ©es
        id: analyze
        run: |
          echo "=== ğŸ“ˆ ANALYSE DES DONNÃ‰ES ==="
          
          if [ ! -f "public/data/gardes_du_jour.json" ]; then
            echo "âŒ ERREUR: Fichier non gÃ©nÃ©rÃ©"
            exit 1
          fi
          
          FILE_SIZE=$(wc -c < "public/data/gardes_du_jour.json")
          echo "ğŸ“ Taille du fichier: ${FILE_SIZE} octets"
          
          PHARMACIES_COUNT=$(node -e "
            try {
              const data = require('./public/data/gardes_du_jour.json');
              console.log(data.total || data.pharmacies?.length || 0);
            } catch (e) {
              console.log('0');
              process.exit(1);
            }
          ")
          echo "ğŸ¥ Nombre de pharmacies: ${PHARMACIES_COUNT}"
          
          PHONE_RATE=$(node -e "
            try {
              const data = require('./public/data/gardes_du_jour.json');
              const withPhone = data.pharmacies.filter(p => p.tel && p.tel !== 'Non listÃ©').length;
              const total = data.pharmacies.length;
              const rate = total > 0 ? Math.round((withPhone / total) * 100) : 0;
              console.log(rate);
            } catch (e) {
              console.log('0');
            }
          ")
          echo "ğŸ“ Taux de tÃ©lÃ©phones: ${PHONE_RATE}%"
          
          PERIODE=$(node -e "
            try {
              const data = require('./public/data/gardes_du_jour.json');
              console.log(data.periode || 'Non spÃ©cifiÃ©e');
            } catch (e) {
              console.log('Erreur');
            }
          ")
          echo "ğŸ“… PÃ©riode: ${PERIODE}"
          
          REGIONS_COUNT=$(node -e "
            try {
              const data = require('./public/data/gardes_du_jour.json');
              const regions = new Set(data.pharmacies.map(p => p.region).filter(r => r));
              console.log(regions.size);
            } catch (e) {
              console.log('0');
            }
          ")
          echo "ğŸŒ RÃ©gions couvertes: ${REGIONS_COUNT}"
          
          # QualitÃ©
          if [ "${PHARMACIES_COUNT}" -lt 10 ]; then
            echo "âš ï¸  ALERTE: Peu de pharmacies trouvÃ©es (< 10)"
            echo "quality=low" >> $GITHUB_OUTPUT
          elif [ "${PHARMACIES_COUNT}" -eq 0 ]; then
            echo "âŒ ERREUR CRITIQUE: Aucune pharmacie trouvÃ©e"
            exit 1
          elif [ "${PHONE_RATE}" -lt 50 ]; then
            echo "âš ï¸  ALERTE: Taux de tÃ©lÃ©phones faible (< 50%)"
            echo "quality=medium" >> $GITHUB_OUTPUT
          else
            echo "âœ… DonnÃ©es de haute qualitÃ©"
            echo "quality=high" >> $GITHUB_OUTPUT
          fi
          
          # Nouvelle syntaxe outputs
          echo "pharmacies_count=${PHARMACIES_COUNT}" >> $GITHUB_OUTPUT
          echo "phone_rate=${PHONE_RATE}" >> $GITHUB_OUTPUT
          echo "period=${PERIODE}" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ Sauvegarde des donnÃ©es
        if: success()
        run: |
          echo "=== ğŸ’¾ SAUVEGARDE ==="
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_DIR="public/data/backups"
          BACKUP_FILE="${BACKUP_DIR}/gardes_${TIMESTAMP}.json"
          
          mkdir -p "${BACKUP_DIR}"
          cp "public/data/gardes_du_jour.json" "${BACKUP_FILE}"
          
          echo "ğŸ“¦ Backup crÃ©Ã©: ${BACKUP_FILE}"
          
          ls -t "${BACKUP_DIR}"/*.json | tail -n +8 | xargs -r rm -f
          echo "ğŸ—‘ï¸  Anciens backups nettoyÃ©s (gardÃ©s: 7 derniers)"

      - name: ğŸ” VÃ©rification des changements
        id: check_changes
        run: |
          echo "=== ğŸ” DÃ‰TECTION DES CHANGEMENTS ==="
          
          git status
          
          if git diff --quiet public/data/gardes_du_jour.json; then
            echo "ğŸ”„ Aucun changement dans les donnÃ©es"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ Changements dÃ©tectÃ©s"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¤ Commit et push des changements (force safe)
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "=== ğŸ“¤ PUBLICATION DES CHANGEMENTS ==="

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Action"

          git add public/data/gardes_du_jour.json

          COMMIT_MESSAGE="ğŸ¥ Mise Ã  jour automatique: ${{ steps.analyze.outputs.pharmacies_count }} pharmacies (${{ steps.analyze.outputs.phone_rate }}% avec tel) - ${{ steps.analyze.outputs.period }}"
          git commit -m "${COMMIT_MESSAGE}"

          # Force push safe pour Ã©viter les conflits futurs
          git push origin main --force-with-lease

          echo "âœ… Changements publiÃ©s avec succÃ¨s!"

      - name: ğŸ“Š GÃ©nÃ©ration du rapport
        if: always()
        run: |
          echo "=== ğŸ“Š RAPPORT FINAL ==="
          echo "Statut: ${{ job.status }}"
          if [ -f "public/data/gardes_du_jour.json" ]; then
            echo "- Pharmacies: ${{ steps.analyze.outputs.pharmacies_count }}"
            echo "- TÃ©lÃ©phones: ${{ steps.analyze.outputs.phone_rate }}%"
            echo "- PÃ©riode: ${{ steps.analyze.outputs.period }}"
          fi
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ SUCCÃˆS: Mise Ã  jour terminÃ©e"
          else
            echo "âŒ Ã‰CHEC: Voir les logs"
          fi

      - name: ğŸš¨ Notification Ã©chec
        if: failure()
        run: |
          echo "âš ï¸  Workflow Ã©chouÃ© â€“ vÃ©rifier les logs GitHub Actions"