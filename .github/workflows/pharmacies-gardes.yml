name: ğŸ¥ Mise Ã  jour quotidienne des pharmacies de garde

on:
  schedule:
    - cron: '0 7 * * *'  # Tous les jours Ã  7h UTC (8h heure Cameroun)
  workflow_dispatch:     # DÃ©clenchement manuel
  push:
    branches: [ main ]
    paths:
      - 'scripts/scrape-gardes-*.js'

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      
    steps:
      - name: ğŸ”„ Synchroniser avec le dÃ©pÃ´t
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸŸ¢ Configuration Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package.json'

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: |
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”„ Installation des dÃ©pendances (prod + dev pour le scraper)..."
          npm ci
          echo "âœ… DÃ©pendances installÃ©es"
          npm list --depth=0

      - name: ğŸš€ ExÃ©cution du scraper
        id: scrape
        run: |
          echo "ğŸ¯ DÃ©marrage du scraping des pharmacies de garde..."
          echo "ğŸŒ Source: https://www.dochelp-cm.org"
          
          START_TIME=$(date +%s)
          node scripts/scrape-gardes-optimized.js
          EXIT_CODE=$?
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          
          echo "â±ï¸  DurÃ©e d'exÃ©cution: ${DURATION} secondes"
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "âŒ Le scraper a Ã©chouÃ© avec le code: $EXIT_CODE"
            exit 1
          fi
          
          echo "âœ… Scraping terminÃ© avec succÃ¨s"

      - name: ğŸ§¹ Nettoyage automatique des donnÃ©es
        id: clean
        run: |
          echo "=== ğŸ§¹ NETTOYAGE AUTOMATIQUE DES DONNÃ‰ES ==="
          
          if [ ! -f "public/data/gardes_du_jour.json" ]; then
            echo "âŒ ERREUR: Fichier source introuvable"
            exit 1
          fi
          
          echo "ğŸ“ Fichier source: gardes_du_jour.json"
          
          # ExÃ©cuter le script de nettoyage
          node scripts/clean-gardes-data.js
          
          # VÃ©rifier que le fichier clean est crÃ©Ã©
          if [ ! -f "public/data/gardes_du_jour_clean.json" ]; then
            echo "âŒ ERREUR: Fichier nettoyÃ© non gÃ©nÃ©rÃ©"
            exit 1
          fi
          
          # Comparer les tailles
          SOURCE_SIZE=$(wc -c < "public/data/gardes_du_jour.json")
          CLEAN_SIZE=$(wc -c < "public/data/gardes_du_jour_clean.json")
          echo "ğŸ“Š Taille source: ${SOURCE_SIZE} octets"
          echo "ğŸ“Š Taille nettoyÃ©e: ${CLEAN_SIZE} octets"
          
          # VÃ©rifier la structure du fichier nettoyÃ©
          echo "ğŸ” VÃ©rification structure du fichier nettoyÃ©..."
          NODES_RESULT=$(node -e "
            try {
              const data = require('./public/data/gardes_du_jour_clean.json');
              const regions = Object.keys(data.regions || {});
              let totalCities = 0;
              let totalPharmacies = 0;
              
              regions.forEach(region => {
                const cities = data.regions[region] || [];
                totalCities += cities.length;
                cities.forEach(city => {
                  totalPharmacies += city.pharmacies?.length || 0;
                });
              });
              
              console.log('OK');
              console.log('Regions:', regions.length);
              console.log('Villes totales:', totalCities);
              console.log('Pharmacies totales:', totalPharmacies);
            } catch (e) {
              console.error('ERROR:', e.message);
              process.exit(1);
            }
          ")
          
          echo "âœ… Nettoyage terminÃ© avec succÃ¨s"

      - name: ğŸ“Š Analyse des donnÃ©es gÃ©nÃ©rÃ©es
        id: analyze
        run: |
          echo "=== ğŸ“ˆ ANALYSE DES DONNÃ‰ES NETTOYÃ‰ES ==="
          
          if [ ! -f "public/data/gardes_du_jour_clean.json" ]; then
            echo "âŒ ERREUR: Fichier nettoyÃ© non trouvÃ©"
            exit 1
          fi
          
          FILE_SIZE=$(wc -c < "public/data/gardes_du_jour_clean.json")
          echo "ğŸ“ Taille du fichier nettoyÃ©: ${FILE_SIZE} octets"
          
          # Analyser le fichier nettoyÃ©
          PHARMACIES_COUNT=$(node -e "
            try {
              const data = require('./public/data/gardes_du_jour_clean.json');
              console.log(data.total || 0);
            } catch (e) {
              console.log('0');
              process.exit(1);
            }
          ")
          echo "ğŸ¥ Nombre total de pharmacies: ${PHARMACIES_COUNT}"
          
          PHONE_RATE=$(node -e "
            try {
              const data = require('./public/data/gardes_du_jour_clean.json');
              let withPhone = 0;
              let total = 0;
              
              Object.values(data.regions || {}).forEach(cities => {
                cities.forEach(city => {
                  city.pharmacies?.forEach(p => {
                    total++;
                    if (p.tel && p.tel !== 'Non listÃ©') {
                      withPhone++;
                    }
                  });
                });
              });
              
              const rate = total > 0 ? Math.round((withPhone / total) * 100) : 0;
              console.log(rate);
            } catch (e) {
              console.log('0');
            }
          ")
          echo "ğŸ“ Taux de tÃ©lÃ©phones: ${PHONE_RATE}%"
          
          PERIODE=$(node -e "
            try {
              const data = require('./public/data/gardes_du_jour_clean.json');
              console.log(data.periode || 'Non spÃ©cifiÃ©e');
            } catch (e) {
              console.log('Erreur');
            }
          ")
          echo "ğŸ“… PÃ©riode: ${PERIODE}"
          
          REGIONS_COUNT=$(node -e "
            try {
              const data = require('./public/data/gardes_du_jour_clean.json');
              const regions = Object.keys(data.regions || {});
              console.log(regions.length);
            } catch (e) {
              console.log('0');
            }
          ")
          echo "ğŸŒ RÃ©gions couvertes: ${REGIONS_COUNT}"
          
          # Nombre de villes distinctes
          CITIES_COUNT=$(node -e "
            try {
              const data = require('./public/data/gardes_du_jour_clean.json');
              let citiesSet = new Set();
              
              Object.values(data.regions || {}).forEach(cities => {
                cities.forEach(city => {
                  if (city.ville) {
                    citiesSet.add(city.ville);
                  }
                });
              });
              
              console.log(citiesSet.size);
            } catch (e) {
              console.log('0');
            }
          ")
          echo "ğŸ™ï¸  Villes distinctes: ${CITIES_COUNT}"
          
          # QualitÃ©
          if [ "${PHARMACIES_COUNT}" -lt 10 ]; then
            echo "âš ï¸  ALERTE: Peu de pharmacies trouvÃ©es (< 10)"
            echo "quality=low" >> $GITHUB_OUTPUT
          elif [ "${PHARMACIES_COUNT}" -eq 0 ]; then
            echo "âŒ ERREUR CRITIQUE: Aucune pharmacie trouvÃ©e"
            exit 1
          elif [ "${PHONE_RATE}" -lt 50 ]; then
            echo "âš ï¸  ALERTE: Taux de tÃ©lÃ©phones faible (< 50%)"
            echo "quality=medium" >> $GITHUB_OUTPUT
          else
            echo "âœ… DonnÃ©es de haute qualitÃ©"
            echo "quality=high" >> $GITHUB_OUTPUT
          fi
          
          # Nouvelle syntaxe outputs
          echo "pharmacies_count=${PHARMACIES_COUNT}" >> $GITHUB_OUTPUT
          echo "phone_rate=${PHONE_RATE}" >> $GITHUB_OUTPUT
          echo "period=${PERIODE}" >> $GITHUB_OUTPUT
          echo "cities_count=${CITIES_COUNT}" >> $GITHUB_OUTPUT

      - name: ğŸ’¾ Sauvegarde des donnÃ©es
        if: success()
        run: |
          echo "=== ğŸ’¾ SAUVEGARDE ==="
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          BACKUP_DIR="public/data/backups"
          
          # CrÃ©er le dossier backups s'il n'existe pas
          mkdir -p "${BACKUP_DIR}"
          
          # Sauvegarder le fichier source
          BACKUP_SOURCE="${BACKUP_DIR}/gardes_source_${TIMESTAMP}.json"
          cp "public/data/gardes_du_jour.json" "${BACKUP_SOURCE}"
          echo "ğŸ“¦ Backup source crÃ©Ã©: ${BACKUP_SOURCE}"
          
          # Sauvegarder le fichier nettoyÃ©
          BACKUP_CLEAN="${BACKUP_DIR}/gardes_clean_${TIMESTAMP}.json"
          cp "public/data/gardes_du_jour_clean.json" "${BACKUP_CLEAN}"
          echo "ğŸ“¦ Backup nettoyÃ© crÃ©Ã©: ${BACKUP_CLEAN}"
          
          # Nettoyer les anciens backups (garder les 7 derniers de chaque type)
          ls -t "${BACKUP_DIR}"/gardes_source_*.json | tail -n +8 | xargs -r rm -f
          ls -t "${BACKUP_DIR}"/gardes_clean_*.json | tail -n +8 | xargs -r rm -f
          
          echo "ğŸ—‘ï¸  Anciens backups nettoyÃ©s (gardÃ©s: 7 derniers de chaque type)"

      - name: ğŸ” VÃ©rification des changements
        id: check_changes
        run: |
          echo "=== ğŸ” DÃ‰TECTION DES CHANGEMENTS ==="
          
          git status
          
          # VÃ©rifier les changements dans les deux fichiers
          CHANGES_DETECTED=false
          
          if git diff --quiet public/data/gardes_du_jour_clean.json; then
            echo "â„¹ï¸  Aucun changement dans gardes_du_jour_clean.json"
          else
            echo "ğŸ“ Changements dÃ©tectÃ©s dans gardes_du_jour_clean.json"
            CHANGES_DETECTED=true
          fi
          
          if git diff --quiet public/data/gardes_du_jour.json; then
            echo "â„¹ï¸  Aucun changement dans gardes_du_jour.json"
          else
            echo "ğŸ“ Changements dÃ©tectÃ©s dans gardes_du_jour.json"
            CHANGES_DETECTED=true
          fi
          
          if [ "$CHANGES_DETECTED" = true ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“¤ Commit et push des changements
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "=== ğŸ“¤ PUBLICATION DES CHANGEMENTS ==="

          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "GitHub Action"

          # Ajouter les deux fichiers
          git add public/data/gardes_du_jour.json
          git add public/data/gardes_du_jour_clean.json

          COMMIT_MESSAGE="ğŸ¥ Mise Ã  jour automatique: ${{ steps.analyze.outputs.pharmacies_count }} pharmacies (${{ steps.analyze.outputs.phone_rate }}% avec tel) - ${{ steps.analyze.outputs.period }} - ${{ steps.analyze.outputs.cities_count }} villes"
          
          echo "ğŸ’¾ Commit: ${COMMIT_MESSAGE}"
          git commit -m "${COMMIT_MESSAGE}"

          # Force push safe pour Ã©viter les conflits futurs
          git push origin main --force-with-lease

          echo "âœ… Changements publiÃ©s avec succÃ¨s!"

      - name: ğŸ“Š GÃ©nÃ©ration du rapport
        if: always()
        run: |
          echo "=== ğŸ“Š RAPPORT FINAL ==="
          echo "Statut: ${{ job.status }}"
          echo "=== DONNÃ‰ES NETTOYÃ‰ES ==="
          if [ -f "public/data/gardes_du_jour_clean.json" ]; then
            echo "- Pharmacies: ${{ steps.analyze.outputs.pharmacies_count }}"
            echo "- TÃ©lÃ©phones: ${{ steps.analyze.outputs.phone_rate }}%"
            echo "- Villes: ${{ steps.analyze.outputs.cities_count }}"
            echo "- PÃ©riode: ${{ steps.analyze.outputs.period }}"
          fi
          
          echo "=== FICHIERS GÃ‰NÃ‰RÃ‰S ==="
          echo "1. gardes_du_jour.json (source brut)"
          echo "2. gardes_du_jour_clean.json (nettoyÃ©, organisÃ© par ville)"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "ğŸ‰ SUCCÃˆS: Mise Ã  jour et nettoyage terminÃ©s"
          else
            echo "âŒ Ã‰CHEC: Voir les logs"
          fi

      - name: ğŸš¨ Notification Ã©chec
        if: failure()
        run: |
          echo "âš ï¸  Workflow Ã©chouÃ© â€“ vÃ©rifier les logs GitHub Actions"
          echo "=== DERNIERS LOGS ==="
          echo "VÃ©rifier les Ã©tapes:"
          echo "1. scrape: Scraping des donnÃ©es"
          echo "2. clean: Nettoyage automatique"
          echo "3. analyze: Analyse qualitÃ©"